{% extends 'base.html' %}

{% load static %}

{% block title %}Dashboard{% endblock %}

{% block head %}
<link rel="stylesheet" href="{% static 'dashboard/dashboard.css' %}">
<!-- Chart.js CDN -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<div class="dashboard-container">
    <!-- Dashboard Header -->
    <div class="text-center mb-4">
        <h1 class="dashboard-title">Dashboard</h1>
        <p class="dashboard-subtitle">Painel de controle de m√©tricas de produtos e pedidos</p>
    </div>

    <!-- 1. M√âTRICAS DO DIA (Prioridade ALTA) -->
    <div class="section-header">
        <span class="section-icon">üìà</span>
        OPERA√á√ïES DO DIA
    </div>

    <div class="metrics-grid grid-3">
        <div class="metric-card primary">
            <div class="metric-header">
                <div class="metric-icon primary">üì¶</div>
                <div class="metric-title">Pedidos Hoje</div>
            </div>
            <div class="metric-value">{{ metrics.orders_today }}</div>
            <div class="metric-subtitle">Total de pedidos criados hoje</div>
        </div>

        <div class="metric-card success">
            <div class="metric-header">
                <div class="metric-icon success">üì¶</div>
                <div class="metric-title">Conclu√≠dos Hoje</div>
            </div>
            <div class="metric-value">{{ metrics.orders_completed_today }}</div>
            <div class="metric-subtitle">Total de pedidos conclu√≠dos hoje</div>
        </div>

        <div class="metric-card danger">
            <div class="metric-header">
                <div class="metric-icon danger">üì¶</div>
                <div class="metric-title">Cancelados Hoje</div>
            </div>
            <div class="metric-value">{{ metrics.orders_cancelled_today }}</div>
            <div class="metric-subtitle">Total de pedidos cancelados hoje</div>
        </div>
    </div>

    <div class="metrics-grid grid-2">
        <div class="metric-card warning">
            <div class="metric-header">
                <div class="metric-icon warning">‚è≥</div>
                <div class="metric-title">Pendentes Hoje</div>
            </div>
            <div class="metric-value {% if metrics.orders_pending_today > 0 %}pending-alert{% endif %}">
                {{ metrics.orders_pending_today }}
            </div>
            <div class="metric-subtitle">Pedidos aguardando processamento</div>
        </div>

        <div class="metric-card {% if metrics.orders_late_today > 0 %}danger{% else %}success{% endif %}">
            <div class="metric-header">
                <div class="metric-icon {% if metrics.orders_late_today > 0 %}danger{% else %}success{% endif %}">üö®
                </div>
                <div class="metric-title">Atrasados Hoje</div>
            </div>
            <div class="metric-value {% if metrics.orders_late_today > 0 %}late-alert{% endif %}">
                {{ metrics.orders_late_today }}
            </div>
            <div class="metric-subtitle">Pedidos com mais de 25min</div>
        </div>
    </div>

    <!-- Receitas por Status -->
    <div class="metrics-grid grid-2" style="margin-bottom: 3rem;">
        <div class="metric-card primary">
            <div class="metric-header">
                <div class="metric-icon primary">üí∞</div>
                <div class="metric-title">Receita Hoje</div>
            </div>
            <div class="metric-value">R$ {{ metrics.revenue_paid_today|floatformat:2 }}</div>
            <div class="metric-subtitle">Faturamento total do dia, com pagamento confirmado</div>
        </div>

        <div class="metric-card warning">
            <div class="metric-header">
                <div class="metric-icon warning">‚è∞</div>
                <div class="metric-title">Receita Pendente Hoje</div>
            </div>
            <div class="metric-value">R$ {{ metrics.revenue_pending_today|floatformat:2 }}</div>
            <div class="metric-subtitle">Valores a receber, com pagamento pendente</div>
        </div>
    </div>

    <!-- 2. M√âTRICAS GERAIS (Vis√£o do Neg√≥cio) -->
    <div class="section-header">
        <span class="section-icon">üéØ</span>
        PERFORMANCE GERAL
    </div>

    <div class="metrics-grid grid-4">
        <div class="metric-card primary">
            <div class="metric-header">
                <div class="metric-icon primary">üèÜ</div>
                <div class="metric-title">Vendas Efetivas</div>
            </div>
            <div class="metric-value">{{ metrics.total_effective_sales }}</div>
            <div class="metric-subtitle">Total de vendas conclu√≠das e pagas</div>
        </div>

        <div class="metric-card success">
            <div class="metric-header">
                <div class="metric-icon success">üíé</div>
                <div class="metric-title">Receita Conclu√≠da</div>
            </div>
            <div class="metric-value">R$ {{ metrics.total_effective_revenue|floatformat:2 }}</div>
            <div class="metric-subtitle">Receita de pedidos conclu√≠dos e pagos (efetivos)</div>
        </div>

        <div class="metric-card info">
            <div class="metric-header">
                <div class="metric-icon primary">üìä</div>
                <div class="metric-title">√öltimos 7 Dias</div>
            </div>
            <div class="metric-value">{{ metrics.effective_sales_last_7_days }}</div>
            <div class="metric-subtitle">R$ {{ metrics.effective_revenue_last_7_days|floatformat:2 }} em receita</div>
        </div>

        <div class="metric-card info">
            <div class="metric-header">
                <div class="metric-icon primary">üìà</div>
                <div class="metric-title">√öltimos 30 Dias</div>
            </div>
            <div class="metric-value">{{ metrics.effective_sales_last_30_days }}</div>
            <div class="metric-subtitle">R$ {{ metrics.effective_revenue_last_30_days|floatformat:2 }} em receita</div>
        </div>
    </div>

    <!-- Produtos -->
    <div class="section-header" style="margin-top: 2rem;">
        <span class="section-icon">üì¶</span>
        PRODUTOS
    </div>

    <div class="metrics-grid grid-3">
        <div class="metric-card primary">
            <div class="metric-header">
                <div class="metric-icon primary">üõí</div>
                <div class="metric-title">Quantidade de Produtos</div>
            </div>
            <div class="metric-value">{{ metrics.total_products }}</div>
            <div class="metric-subtitle">Total de produtos cadastrados</div>
        </div>

        <div class="metric-card success">
            <div class="metric-header">
                <div class="metric-icon success">‚úÖ</div>
                <div class="metric-title">Produtos Ativos</div>
            </div>
            <div class="metric-value">{{ metrics.total_active_products }}</div>
            <div class="metric-subtitle">Dispon√≠veis para venda</div>
        </div>

        <div class="metric-card warning">
            <div class="metric-header">
                <div class="metric-icon warning">‚è∏Ô∏è</div>
                <div class="metric-title">Produtos Inativos</div>
            </div>
            <div class="metric-value">{{ metrics.total_inactive_products }}</div>
            <div class="metric-subtitle">Indispon√≠veis temporariamente</div>
        </div>
    </div>

    <!-- 3. GR√ÅFICOS (Tend√™ncias Visuais) -->
    <div class="section-header" style="margin-top: 3rem;">
        <span class="section-icon">üìä</span>
        TEND√äNCIAS DE VENDAS
    </div>

    <div class="metrics-grid grid-2">
        <div class="chart-card">
            <h4 class="chart-title">Vendas Efetivas - √öltimos 7 Dias</h4>
            <div class="chart-container">
                <canvas id="revenueChart7Days"></canvas>
            </div>
        </div>

        <div class="chart-card">
            <h4 class="chart-title">Vendas Efetivas - √öltimos 30 Dias</h4>
            <div class="chart-container">
                <canvas id="revenueChart30Days"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js Script -->
<script>
    document.addEventListener('DOMContentLoaded', function () {
    // Dados dos gr√°ficos
    const revenueData7Days = {{ metrics.effective_revenue_chart_7_days| safe }};
    const revenueData30Days = {{ metrics.effective_revenue_chart_30_days| safe }};
    const labels7Days = [{% for label in metrics.chart_labels_7_days %}"{{ label }}"{% if not forloop.last %}, {% endif %} {% endfor %}];
    const labels30Days = [{% for label in metrics.chart_labels_30_days %}"{{ label }}"{% if not forloop.last %}, {% endif %} {% endfor %}];

    // Configura√ß√£o comum
    const commonOptions = {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
            legend: {
                display: false
            },
            tooltip: {
                backgroundColor: 'rgba(0, 0, 0, 0.8)',
                titleColor: 'white',
                bodyColor: 'white',
                cornerRadius: 8,
                callbacks: {
                    label: function (context) {
                        return 'Receita: R$ ' + context.parsed.y.toLocaleString('pt-BR', {
                            minimumFractionDigits: 2,
                            maximumFractionDigits: 2
                        });
                    }
                }
            }
        },
        scales: {
            y: {
                beginAtZero: true,
                grid: {
                    color: 'rgba(0, 0, 0, 0.1)'
                },
                ticks: {
                    callback: function (value) {
                        return 'R$ ' + value.toLocaleString('pt-BR');
                    }
                }
            },
            x: {
                grid: {
                    display: false
                }
            }
        }
    };

    // Gr√°fico 7 dias
    new Chart(document.getElementById('revenueChart7Days'), {
        type: 'line',
        data: {
            labels: labels7Days,
            datasets: [{
                data: revenueData7Days,
                borderColor: '#27ae60',
                backgroundColor: 'rgba(39, 174, 96, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#27ae60',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        },
        options: commonOptions
    });

    // Gr√°fico 30 dias
    new Chart(document.getElementById('revenueChart30Days'), {
        type: 'line',
        data: {
            labels: labels30Days,
            datasets: [{
                data: revenueData30Days,
                borderColor: '#3498db',
                backgroundColor: 'rgba(52, 152, 219, 0.1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointBackgroundColor: '#3498db',
                pointBorderColor: '#fff',
                pointBorderWidth: 2,
                pointRadius: 3,
                pointHoverRadius: 5
            }]
        },
        options: commonOptions
    });
    });
</script>
{% endblock %}