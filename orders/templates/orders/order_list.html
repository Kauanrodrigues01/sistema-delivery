{% extends 'base.html' %}

{% load static %}
{% load compress %}

{% block title %}Meus Pedidos{% endblock %}

{% block head %}
{% compress css %}
<link rel="stylesheet" href="{% static 'orders/styles.css' %}">
<link rel="stylesheet" href="{% static 'global/buttons-default-style.css' %}">
{% endcompress %}
{% endblock %}

{% block content %}
<main class="main-content">
  <div class="container">
    <!-- Hero Section -->
    <section class="hero-section">
      <h2>Meus Pedidos</h2>
      <p>Acompanhe o histórico dos seus pedidos realizados</p>
    </section>

    <!-- Orders Grid -->
    {% if orders %}
    <section class="orders-grid">
      {% for order in orders %}
      <div class="order-card">
        <div class="order-card-header">
          <div class="order-card-id">Pedido #{{ order.id }}</div>
          <div class="order-card-date">{{ order.created_at|date:"d/m/Y H:i" }}</div>
        </div>

        <div class="order-card-body">
          <div class="order-info-row">
            <span class="order-info-label">Status do Pedido:</span>
            <span class="status-badge 
                            {% if order.status == 'pending' %}status-pending
                            {% elif order.status == 'completed' %}status-completed
                            {% else %}status-cancelled
                            {% endif %}">
              {% if order.status == 'pending' %}
              Pendente
              {% elif order.status == 'completed' %}
              Concluído
              {% elif order.status == 'cancelled' %}
              Cancelado
              {% endif %}
            </span>
          </div>

          <div class="order-info-row">
            <span class="order-info-label">Status do Pagamento:</span>
            <span class="status-badge 
                            {% if order.payment_status == 'pending' %}payment-pending
                            {% elif order.payment_status == 'paid' %}payment-paid
                            {% else %}payment-cancelled
                            {% endif %}">
              {% if order.payment_status == 'pending' %}
              Pendente
              {% elif order.payment_status == 'paid' %}
              Pago
              {% else %}
              Cancelado
              {% endif %}
            </span>
          </div>

          <div class="order-info-row">
            <span class="order-info-label">Método de Pagamento:</span>
            <span class="order-info-value">
              {% if order.payment_method == 'pix' %}
              PIX
              {% elif order.payment_method == 'dinheiro' %}
              Dinheiro
              {% elif order.payment_method == 'cartao_online' %}
              Cartão (Online)
              {% elif order.payment_method == 'cartao_presencial' %}
              Cartão (Presencial)
              {% endif %}
            </span>
          </div>

          {% if order.payment_integration_failed %}
          <div class="integration-warning">
            <i data-lucide="alert-triangle"></i>
            <div>
              <strong>Atenção:</strong> A integração de pagamento apresentou problemas.
              {% if order.payment_method == 'pix' %}
              O pagamento será processado manualmente.
              {% elif order.payment_method == 'cartao_presencial' %}
              O pagamento será realizado no momento da entrega.
              {% endif %}
            </div>
          </div>
          {% endif %}

          <div class="order-info-row">
            <span class="order-info-label">Total:</span>
            <span class="order-total">R$ {{ order.total_price|floatformat:2 }}</span>
          </div>
        </div>

        <div class="order-card-footer">
          <div style="display: flex; gap: 0.5rem; flex-direction: column;">
            <a href="{% url 'orders:order_detail' order.id %}" class="view-order-btn">Ver Detalhes</a>
            {% if order.status == 'pending' and order.payment_status == 'pending' %}
            <button class="cancel-order-btn" data-order-id="{{ order.id }}">
              Cancelar Pedido
            </button>
            {% endif %}
          </div>
        </div>
      </div>
      {% endfor %}
    </section>
    {% else %}
    <section class="orders-empty">
      <i data-lucide="shopping-bag"></i>
      <h3>Nenhum pedido encontrado</h3>
      <p>Você ainda não realizou nenhum pedido.</p>
      <a href="{% url 'product_list' %}" class="btn btn-primary">Ver Produtos</a>
    </section>
    {% endif %}
  </div>
</main>
<script>
  // Initialize Lucide icons
  if (window.lucide) {
    window.lucide.createIcons();
  }

  // Handle order cancellation
  document.addEventListener('DOMContentLoaded', function () {
    const cancelButtons = document.querySelectorAll('.cancel-order-btn');

    cancelButtons.forEach(button => {
      button.addEventListener('click', async function () {
        if (!confirm('Tem certeza que deseja cancelar este pedido? Esta ação não pode ser desfeita.')) {
          return;
        }

        const orderId = this.dataset.orderId;
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value ||
          document.cookie.split('; ').find(row => row.startsWith('csrftoken='))?.split('=')[1];

        try {
          const response = await fetch(`/orders/${orderId}/cancel/`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': csrfToken
            }
          });

          const data = await response.json();

          if (data.success) {
            alert('Pedido cancelado com sucesso!');
            window.location.reload();
          } else {
            alert(data.error || 'Erro ao cancelar pedido.');
          }
        } catch (error) {
          console.error('Error:', error);
          alert('Erro ao cancelar pedido. Tente novamente.');
        }
      });
    });
  });
</script>
{% endblock %}